begin
  Post.create!(
    title: "Using Rack Applications Inside GWT Hosted Mode",
            created_at: "September 21, 2009",
            markdown_body: "#__September 21, 2009__\n\nThis guide will show you how you can use JRuby to run any Rack application inside Google Web Toolkit's (GWT) hosted mode server so your interface and your backend are of the Same Origin.\n\n##Background\n\nGWT has two ways of interacting with a server: GWT Remote Procedure Call (RPC) and plain HTTP (XHR). GWT-RPC is a high level library designed for interacting with server-side Java code. GWT-RPC implements the GWT Remote Service interface allowing you to call those methods from the user interface. Essentially, GWT handles the dirty work for you. However, it only works on Java backends that can implement that interface. Since most of my backends are Sinatra/Rack applications, I'll be using the plain HTTP library.\n\n##The problem\n\nDue to the restriction of the Same Origin policy, the interface served out of GWT's development, or Hosted Mode server can only make requests back to itself. If you were using real servlets or GWT's RemoteService this wouldn't be an issue; but since Rack applications listen on their own port, you cannot make requests from GWT to our application without resorting to something like JSONP or server-side proxying. This leaves you having to compile our interface to HTML/JS/CSS, which is lengthy process, and serve it from the origin of the Rack application to see our changes.\n\n##The solution\n\nSince I wanted to develop using GWT's development environment with a Rack backend, I devised a way to use jruby-rack to load arbitrary Rack applications alongside our interface.\n\n  1. Download and unpack the latest GWT for your platform (mine being linux) and goto it:\n\n{% highlight bash linenos %}\nwget http://google-web-toolkit.googlecode.com/files/gwt-linux-1.7.0.tar.bz2tar -xvjpf gwt-linux-1.7.0.tar.bz2cd gwt-linux-1.7.02 .Download the latest jruby-complete.jar:\n{% endhighlight %}\n\n{% highlight bash linenos %}\nwget http://repository.codehaus.org/org/jruby/jruby-complete/1.3.1/jruby-complete-1.3.1.jarmv jruby-complete-1.3.1.jar jruby-complete.jar\n{% endhighlight %}\n\n  2. Download the latest jruby-rack.jar\n\n{% highlight bash linenos %}\nwget http://repository.codehaus.org/org/jruby/rack/jruby-rack/0.9.4/jruby-rack-0.9.4.jarmv jruby-rack-0.9.4.jar jruby-rack.jar\n{% endhighlight %}\n\n  3. Create an app with webAppCreator:\n\n{% highlight bash linenos %}\n./webAppCreator -out MySinatra com.example.MySinatracd MySinatra\n{% endhighlight %}\n\n  4. In order for this to work you have to package any gem dependencies your backend needs (sinatra, in our case) as jars within your application. For Sinatra it looks like this:\n\n{% highlight bash linenos %}\njava -jar jruby-complete.jar -S gem install -i ./sinatra sinatra --no-rdoc --no-ri jar cf sinatra.jar -C sinatra .\n{% endhighlight %}\n\n  5. Add jruby-complete.jar, jruby-rack.jar, sinatra.jar (and any other jars you've created) to the libs target of your build.xml:\n\n{% highlight xml linenos %}\n\u003ctarget name=\"libs\" description=\"Copy libs to WEB-INF/lib\"\u003e \n  \u003cmkdir dir=\"war/WEB-INF/lib\" /\u003e \n  \u003ccopy todir=\"war/WEB-INF/lib\" file=\"${gwt.sdk}/gwt-servlet.jar\" \u003e\n  \u003ccopy todir=\"war/WEB-INF/lib\" file=\"${gwt.sdk}/jruby-complete.jar\" /\u003e\n  \u003ccopy todir=\"war/WEB-INF/lib\" file=\"${gwt.sdk}/jruby-rack.jar\" /\u003e\n  \u003ccopy todir=\"war/WEB-INF/lib\" file=\"${gwt.sdk}/sinatra.jar\" /\u003e\n\u003c/target\u003e\n{% endhighlight %}\n\n  6. Add these lines right after `\u003cweb-app\u003e` in war/WEB-INF/web.xml:\n\n{% highlight xml linenos %}\n\u003ccontext-param\u003e \n  \u003cparam-name\u003erackup\u003c/param-name\u003e \n  \u003cparam-value\u003e \n    require 'rubygems' \n\trequire './lib/sinatra_app' \n\tmap '/api' do run MyApp  \n\tend \n  \u003c/param-value\u003e \n\u003c/context-param\u003e\n\u003cfilter\u003e\n  \u003cfilter-name\u003eRackFilter\u003c/filter-name\u003e\n  \u003cfilter-class\u003eorg.jruby.rack.RackFilter\u003c/filter-class\u003e\n\u003c/filter\u003e\n\u003cfilter-mapping\u003e\n  \u003cfilter-name\u003eRackFilter\u003c/filter-name\u003e\n  \u003curl-pattern\u003e/api/*\u003c/url-pattern\u003e\n\u003c/filter-mapping\u003e\n\u003clistener\u003e\n  \u003clistener-class\u003eorg.jruby.rack.RackServletContextListener\u003c/listener-class\u003e\n\u003c/listener\u003e\n{% endhighlight %}\n\nNote: All you're doing here is passing the contents of a config.ru file into the `\u003cparam-value\u003e` element for the `\u003ccontext-param\u003e` (make sure this is HTML encoded!). This states that any request to /api is to be handled by your Sinatra application and not GWT's Hosted mode servlet.\n\n  7. Create your Sinatra backend and place it in war/WEB-INF/lib/sinatra_app.rb\n\n{% highlight ruby linenos %}\nrequire 'sinatra'\nrequire 'open-uri'\n\nclass MyApp \u003c Sinatra::Base\n\n  get '/showpage' do\n    open('http://www.yahoo.com').read\n  end\n\n  get '/helloworld' do\n    'hello world'\n  end\n\nend\n{% endhighlight %}\n\n  8. Run your new awesome setup:\n\n{% highlight bash linenos %}\nant hosted\n{% endhighlight %}\n\nNow when you navigate to http://localhost:8888/api/helloworld orhttp://localhost:8888/api/showpage you should see the Sinatra application being served via GWT.",
            markdown_excerpt: "#__September 21, 2009__ This guide will show you how you can use JRuby to run any Rack application inside Google Web Toolkit's (GWT) hosted mode"
  )
  puts "Imported #{"Using Rack Applications Inside GWT Hosted Mode"}"
rescue ActiveRecord::RecordInvalid => e
  puts "Error importing 21-09-2009-Rack-Applications-Inside-GWT.markdown: #{e.message}"
rescue => e
  puts "Unexpected error importing 21-09-2009-Rack-Applications-Inside-GWT.markdown: #{e.message}"
end
